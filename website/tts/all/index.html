<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>

    <title>NaM</title>
</head>

<body>
<!--<iframe src="silence.mp3" allow="autoplay" id="audio" style="display:none"></iframe>-->
<iframe src="https://olafwempe.com/mp3/silence/silence.mp3" type="audio/mp3" allow="autoplay" id="audio" style="display:none"></iframe>
<audio id="player" controls="" style="display:none">
    <source id="source" type="audio/wav">
</audio>
</body>
<footer>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://unpkg.com/twitch-js@2.0.0-beta.33/dist/twitch.js"></script>
    <script>
      function findGetParameter (parameterName) {
        let result = null
        let tmp = []
        location.search
          .substr(1)
          .split("&")
          .forEach(function (item) {
            tmp = item.split("=")
            if (tmp[0] === parameterName) {result = decodeURIComponent(tmp[1])}
          })
        return result
      }
      async function speak (text, voice = "Brian") {
        let speak = await fetch("https://api.streamelements.com/kappa/v2/speech?voice=" +
          voice +
          "&text=" +
          encodeURIComponent(text.trim()))

        if (speak.status !== 200) {
          let text = await speak.text()

          ga('send', {
            hitType: 'event',
            eventCategory: 'streamlabs',
            eventAction: 'api-error',
            eventLabel: text
          })

          return
        }

        let mp3 = await speak.blob()

        let blobUrl = URL.createObjectURL(mp3)
        document.getElementById("source").setAttribute("src", blobUrl)
        let player = document.getElementById("player")
        player.pause()
        player.load()
        player.play()
      }
    </script>
    <script>
      // Instantiate client.
      // noinspection JSUnresolvedFunction
      const {api, chat} = new TwitchJs({token: "randomstring", username: "justinfan47"});

      // Connect ...
      chat.connect().then(() => {
        let channel = findGetParameter("channel")
        if (channel) {
          chat.join(channel)
          //speak("Connected to " + channel)
        } else {
          console.log("No channel parameter")
        }
      })

      chat.on("PRIVMSG", (msgObj) => {
        console.log(msgObj)
        speak(msgObj.username + " says " + msgObj.message)
      })

    </script>
</footer>
</html>
