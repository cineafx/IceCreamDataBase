<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>

  <title>NaM</title>
</head>

<body>
<!--<iframe src="silence.mp3" allow="autoplay" id="audio" style="display:none"></iframe>-->
<iframe src="https://olafwempe.com/mp3/silence/silence.mp3" type="audio/mp3" allow="autoplay" id="audio"
        style="display:none"></iframe>
<audio id="player" controls="" style="display:none">
  <source id="source" type="audio/wav">
</audio>
</body>
<footer>
  <!--suppress JSUnresolvedLibraryURL -->
  <script src="https://unpkg.com/twitch-js@2.0.0-beta.33/dist/twitch.js"></script>
  <script>
    const voices = ["Aditi", "Amy", "Astrid", "Bianca", "Brian", "Carla", "Carmen", "Celine", "Chantal", "Conchita", "Cristiano", "Dora", "Emma", "Enrique", "Ewa", "Filiz", "Geraint", "Giorgio", "Gwyneth", "Hans", "Ines", "Ivy", "Jacek", "Jan", "Joanna", "Joey", "Justin", "Karl", "Kendra", "Kimberly", "Liv", "Lotte", "Mads", "Maja", "Marlene", "Mathieu", "Matthew", "Maxim", "Mia", "Miguel", "Mizuki", "Naja", "Nicole", "Penelope", "Raveena", "Ricardo", "Ruben", "Russell", "Salli", "Seoyeon", "Takumi", "Tatyana", "Vicki", "Vitoria", "Zhiyu", /* Less refinded ones */ "An", "Andika", "Asaf", "Danny", "Filip", "Guillaume", "HanHan", "Heather", "Heidi", "Hemant", "Herena", "Hoda", "Huihui", "Ivan", "Jakub", "Kalpana", "Kangkang", "Karsten", "Lado", "Linda", "Matej", "Michael", "Naayf", "Pattara", "Rizwan", "Sean", "Stefanos", "Szabolcs", "Tracy", "Valluvar", "Yaoyao", "Zhiwei"]
    const defaultVoice = "Brian"
    const defaultTtsRateLimit = 1000


    let audioPlaying = false
    document.getElementById("player").addEventListener("ended", () => audioPlaying = false)

    function findGetParameter(parameterName) {
      let result = null
      let tmp = []
      location.search
        .substr(1)
        .split("&")
        .forEach(function (item) {
          tmp = item.split("=")
          if (tmp[0].toLowerCase() === parameterName.toLowerCase()) {
            result = decodeURIComponent(tmp[1])
          }
        })
      return result
    }

    async function speak(text, voice = "Brian") {
      if (noSkip && audioPlaying) {
        return
      }
      audioPlaying = true
      if (!voices.includes(voice)) {
        voice = defaultVoice
      }
      let speak = await fetch("https://api.streamelements.com/kappa/v2/speech?voice=" +
        voice +
        "&text=" +
        encodeURIComponent(text.trim()))
      if (speak.status !== 200) {
        console.warn(await speak.text())
        return
      }
      let mp3 = await speak.blob()
      let blobUrl = URL.createObjectURL(mp3)
      document.getElementById("source").setAttribute("src", blobUrl)
      let player = document.getElementById("player")
      player.pause()
      player.load()
      player.play()
    }
  </script>
  <script>
    // Instantiate client.
    // noinspection JSUnresolvedFunction
    const {api, chat} = new TwitchJs({token: "randomstring", username: "justinfan47", log: {level: "warn"}})

    let channels = (findGetParameter("channels") || "").split(",").filter(Boolean)
    let singleChannel = findGetParameter("channel")
    if (singleChannel) {
      channels.push(singleChannel)
    }
    let sayNames = !!findGetParameter("names")
    let voice = findGetParameter("voice") || defaultVoice
    let ttsRatelimit = parseInt(findGetParameter("ttsRateLimit")) || defaultTtsRateLimit
    let noSkip = !!findGetParameter("noSkip")

    let shouldSend = true

    // Connect ...
    chat.connect().then(() => {
      channels.forEach(channel => chat.join(channel))
    })

    chat.on("PRIVMSG", (msgObj) => {
      if (shouldSend) {
        shouldSend = false
        let ttsMessage = msgObj.message
        if (sayNames) {
          ttsMessage = msgObj.username + " says " + ttsMessage
        }
        console.log("TTS: " + msgObj.username + ": " + msgObj.message)
        setTimeout(() => shouldSend = true, ttsRatelimit)
        speak(ttsMessage, voice)
      }
    })
  </script>
</footer>
</html>
