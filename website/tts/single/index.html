<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
    
    <title>Text to Speech</title>
  </head>

  <body>
  <!--<iframe src="silence.mp3" allow="autoplay" id="audio" style="display:none"></iframe>-->
  <iframe src="https://olafwempe.com/mp3/silence/silence.mp3" type="audio/mp3" allow="autoplay" id="audio" style="display:none"></iframe>
  <audio id="player" controls="" style="display:none">
	<source id="source" type="audio/wav">
  </audio>
  </body>
  <footer>
	<script>

      function findGetParameter(parameterName) {
        let result = null
        let tmp = []
        location.search
                .substr(1)
                .split("&")
                .forEach(function (item) {
                  tmp = item.split("=")
                  if (tmp[0] === parameterName) {result = decodeURIComponent(tmp[1])}
                })
        return result
      }

      async function speak (text, voice = "Brian") {

        let speak = await fetch("https://api.streamelements.com/kappa/v2/speech?voice=" +
          voice +
          "&text=" +
          encodeURIComponent(text.trim()))

        if (speak.status !== 200) {
          let text = await speak.text()

          ga('send', {
            hitType: 'event',
            eventCategory: 'streamlabs',
            eventAction: 'api-error',
            eventLabel: text
          })

          return
        }

        let mp3 = await speak.blob()

        let blobUrl = URL.createObjectURL(mp3)
        document.getElementById("source").setAttribute("src", blobUrl)
        let player = document.getElementById("player")
        player.pause()
        player.load()
        player.play()
      }

      function connect () {
        let socket = new WebSocket('wss://ws.icecreamdatabase.com')
        // Connection opened
        socket.addEventListener('open', function (event) {
          console.log("Connected")
          socket.send(JSON.stringify({channel: findGetParameter("channel") || ""}))
        })

        // Listen for messages
        socket.addEventListener('message', function (event) {
          console.log('Message from server ', event.data)
          let obj = JSON.parse(event.data)
          console.log(obj)
          if (obj.message && obj.channel && obj.channel === findGetParameter("channel")) {
            if (obj.voice) {
              speak(obj.message, obj.voice)
            } else {
              speak(obj.message)
            }
          }
        })

        socket.addEventListener('close', event => {
          socket = null
          connect()
        })
        socket.addEventListener('error', event => {
          //socket = null
          //connect()
        })
      }
      connect()

	</script>
  </footer>
</html>
